void loopSm(void);
void CeckCollision(void);
void UpdatePosition(void);
void DrawBrick(unsigned char x, unsigned short int y, unsigned char Brickn);
void DrawSM(unsigned char x, unsigned short int y, unsigned char SMn, _Bool ForBack, _Bool ClearSM);
void DrawLevel();
void LoadLevel(char posSm);
void EndJump(char a);
void StartJump(char a);
void DrawRefreshRate(char nSM, char En1,char En2,char En3,char En4);
void CollisionTest(void);
void CollisionTestTwo(void);
void CeckCollisionNewPhysics(void);
signed short int ItemPos[5][9]={//posx,posy,velx,vely,gravity,onGround,backFor,collision,live/die
	{16,176,0,0,2,1,0,0,1},//SM
	{128,96,2,0,1,0,0,0,1},//enemy1
	{144,240,2,0,1,0,0,0,1},//enemy2
	{90,175,2,0,1,0,0,0,0},//enemy3
	{150,175,2,0,1,0,0,0,0}//enemy4
};

signed short int OldItemPos[5][2]={//posx,posy
	{16,1192},//SM
	{112,96},//enemy1
	{100,175},//enemy2
	{100,175},//enemy3
	{100,175}//enemy4
};

unsigned short int LevelPosEn[3][4][3]={//x,y,die/live
				{
				{128,96,1},
				{144,240,1},
				{160,80,0},
				{160,80,0}
				},
				{
				{80,140,1},
				{64,198,1},
				{160,240,1},
				{160,80,0}
				},
				{
				{100,96,1},
				{144,80,1},
				{160,80,1},
				{176,240,1}
				}				
			};
			
unsigned char mario[5][256]={
               { 0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
                 0xff,0xff,0xff,0xff,0xff,0xe0,0xe0,0xe0,0xe0,0xe0,0xe0,0xff,0xff,0xff,0xff,0xff,
                 0xff,0xff,0xff,0xff,0xe0,0xe0,0xe0,0xe0,0xe0,0xe0,0xe0,0xe0,0xe0,0xe0,0xff,0xff,
                 0xff,0xff,0xff,0xff,0x24,0x24,0x24,0x24,0xe3,0xe3,0x00,0xe3,0xff,0xff,0xff,0xff,
                 0xff,0xff,0xff,0x24,0x24,0xe3,0x24,0xe3,0xe3,0xe3,0x00,0xe3,0xe3,0xe3,0xff,0xff,
                 0xff,0xff,0xff,0x24,0x24,0xe3,0x24,0x24,0xe3,0xe3,0xe3,0x00,0xe3,0xe3,0xe3,0xff,
                 0xff,0xff,0xff,0x24,0x24,0x24,0xe3,0xe3,0xe3,0xe3,0x00,0x00,0x00,0x00,0xff,0xff,
                 0xff,0xff,0xff,0xff,0xff,0xe3,0xe3,0xe3,0xe3,0xe3,0xe3,0xe3,0xff,0xff,0xff,0xff,
                 0xff,0xff,0xff,0xff,0xe0,0xe0,0xe0,0xe0,0x03,0xe0,0xe3,0xe3,0xff,0xff,0xff,0xff,
                 0xff,0xff,0xff,0xe3,0xe3,0xe0,0xe0,0xe0,0xe0,0xe0,0xe3,0xe3,0xe3,0xff,0xff,0xff,
                 0xff,0xff,0xe3,0xe3,0xe3,0x03,0xe0,0xe0,0xe0,0xe0,0xe3,0xe3,0xff,0xff,0xff,0xff,
                 0xff,0xff,0xe0,0xe0,0xe0,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0xff,0xff,0xff,0xff,
                 0xff,0xff,0xe0,0xe0,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0xff,0xff,0xff,0xff,
                 0xff,0xe0,0xe0,0xe0,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0xff,0xff,0xff,0xff,0xff,
                 0xff,0xe0,0xe0,0xff,0xff,0xe0,0xe0,0xe0,0xe0,0xe0,0xff,0xff,0xff,0xff,0xff,0xff,
                 0xff,0xff,0xff,0xff,0xff,0xe0,0xe0,0xe0,0xe0,0xe0,0xe0,0xff,0xff,0xff,0xff,0xff,},
                 
               { 0xff,0xff,0xff,0xff,0xff,0xe0,0xe0,0xe0,0xe0,0xe0,0xe0,0xff,0xff,0xff,0xff,0xff,
                 0xff,0xff,0xff,0xff,0xe0,0xe0,0xe0,0xe0,0xe0,0xe0,0xe0,0xe0,0xe0,0xe0,0xff,0xff,
                 0xff,0xff,0xff,0xff,0x24,0x24,0x24,0x24,0xe3,0xe3,0x00,0xe3,0xff,0xff,0xff,0xff,
                 0xff,0xff,0xff,0x24,0x24,0xe3,0x24,0xe3,0xe3,0xe3,0x00,0xe3,0xe3,0xe3,0xff,0xff,
                 0xff,0xff,0xff,0x24,0x24,0xe3,0x24,0x24,0xe3,0xe3,0xe3,0x00,0xe3,0xe3,0xe3,0xff,
                 0xff,0xff,0xff,0x24,0x24,0x24,0xe3,0xe3,0xe3,0xe3,0x00,0x00,0x00,0x00,0xff,0xff,
                 0xff,0xff,0xff,0xff,0xff,0xe3,0xe3,0xe3,0xe3,0xe3,0xe3,0xe3,0xe3,0xff,0xff,0xff,
                 0xff,0xff,0xe0,0xe0,0xe0,0xe0,0xe0,0x03,0x03,0xe0,0xe0,0xff,0xff,0xff,0xff,0xff,
                 0xe3,0xe3,0xe3,0xe0,0xe0,0xe0,0xe0,0x03,0x03,0x03,0xe0,0xe0,0xe0,0xe3,0xe3,0xe3,
                 0xe3,0xe3,0xe3,0xe3,0xe0,0xe0,0xe0,0x03,0xae,0x03,0x03,0x03,0xe0,0xe0,0xe3,0xe3,
                 0xe3,0xe3,0xe3,0xff,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0xe0,0xe0,0xff,
                 0xff,0xff,0xff,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0xe0,0xe0,0xff,
                 0xff,0xff,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0xe0,0xe0,0xff,
                 0xff,0xe0,0xe0,0xe0,0x03,0x03,0x03,0xff,0xff,0x03,0x03,0x03,0x03,0xe0,0xe0,0xff,
                 0xff,0xe0,0xe0,0xe0,0xe0,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
                 0xff,0xff,0xe0,0xe0,0xe0,0xe0,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff},
                {                
                 0xff,0xff,0xff,0xff,0xff,0xe0,0xe0,0xe0,0xe0,0xe0,0xe0,0xff,0xff,0xff,0xff,0xff,
                 0xff,0xff,0xff,0xff,0xe0,0xe0,0xe0,0xe0,0xe0,0xe0,0xe0,0xe0,0xe0,0xe0,0xff,0xff,
                 0xff,0xff,0xff,0xff,0x24,0x24,0x24,0x24,0xe3,0xe3,0x00,0xe3,0xff,0xff,0xff,0xff,
                 0xff,0xff,0xff,0x24,0x24,0xe3,0x24,0xe3,0xe3,0xe3,0x00,0xe3,0xe3,0xe3,0xff,0xff,
                 0xff,0xff,0xff,0x24,0x24,0xe3,0x24,0x24,0xe3,0xe3,0xe3,0x00,0xe3,0xe3,0xe3,0xff,
                 0xff,0xff,0xff,0x24,0x24,0x24,0xe3,0xe3,0xe3,0xe3,0x00,0x00,0x00,0x00,0xff,0xff,
                 0xff,0xff,0xff,0xff,0xff,0xe3,0xe3,0xe3,0xe3,0xe3,0xe3,0xe3,0xe3,0xff,0xff,0xff,
                 0xff,0xff,0xff,0xff,0xe0,0xe0,0xe0,0x03,0xe0,0xe0,0xe0,0xff,0xff,0xff,0xff,0xff,
                 0xff,0xff,0xff,0xe0,0xe0,0xe0,0xe0,0xe0,0x03,0x03,0xe0,0xe0,0xff,0xff,0xff,0xff,
                 0xff,0xff,0xff,0xe0,0xe0,0xe0,0xe0,0x03,0x03,0xfc,0x03,0x03,0xfc,0xff,0xff,0xff,
                 0xff,0xff,0xff,0xe0,0xe0,0xe0,0xe0,0xe0,0x03,0x03,0x03,0x03,0x03,0xff,0xff,0xff,
                 0xff,0xff,0xff,0x03,0x03,0xe0,0xe0,0xe3,0xe3,0xe3,0x03,0x03,0x03,0xff,0xff,0xff,
                 0xff,0xff,0xff,0xff,0x03,0x03,0xe0,0xe3,0xe3,0x03,0x03,0x03,0xff,0xff,0xff,0xff,
                 0xff,0xff,0xff,0xff,0xff,0x03,0x03,0x03,0x03,0xe0,0xe0,0xe0,0xff,0xff,0xff,0xff,
                 0xff,0xff,0xff,0xff,0xff,0xe0,0xe0,0xe0,0xe0,0xe0,0xe0,0xe0,0xe0,0xff,0xff,0xff,
                 0xff,0xff,0xff,0xff,0xff,0xe0,0xe0,0xe0,0xe0,0xe0,0xff,0xff,0xff,0xff,0xff,0xff,},
				{                
                 0xff,0xff,0xff,0xff,0xff,0xff,0x24,0x24,0x24,0x24,0xff,0xff,0xff,0xff,0xff,0xff,
                 0xff,0xff,0xff,0xff,0xff,0x24,0x24,0x24,0x24,0x24,0x24,0xff,0xff,0xff,0xff,0xff,
                 0xff,0xff,0xff,0xff,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0xff,0xff,0xff,0xff,
                 0xff,0xff,0xff,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0xff,0xff,0xff,
                 0xff,0xff,0x24,0x00,0x00,0x24,0x24,0x24,0x24,0x24,0x24,0x00,0x00,0x24,0xff,0xff,
                 0xff,0x24,0x24,0x24,0xe3,0x00,0x24,0x24,0x24,0x24,0x00,0xe3,0x24,0x24,0x24,0xff,
                 0xff,0x24,0x24,0x24,0xe3,0x00,0x00,0x00,0x00,0x00,0x00,0xe3,0x24,0x24,0x24,0xff,
                 0x24,0x24,0x24,0x24,0xe3,0x00,0xe3,0x03,0xe0,0xe3,0x00,0xe3,0x24,0x24,0x24,0x24,
                 0x24,0x24,0x24,0x24,0xe3,0xe3,0xe3,0xe0,0x03,0xe3,0xe3,0xe3,0x24,0x24,0x24,0x24,
                 0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,
                 0xff,0x24,0x24,0x24,0x24,0xe3,0xe3,0xe3,0xe3,0xe3,0xe3,0x24,0x24,0x24,0x24,0xff,
                 0xff,0xff,0xff,0xff,0xe3,0xe3,0xe3,0xe3,0xe3,0xe3,0xe3,0xe3,0xff,0xff,0xff,0xff,
                 0xff,0xff,0xff,0xff,0xe3,0xe3,0xe3,0xe3,0xe3,0xe3,0xe3,0xe3,0x00,0x00,0xff,0xff,
                 0xff,0xff,0xff,0x00,0x00,0xe3,0xe3,0xe3,0xe3,0xe3,0x00,0x00,0x00,0x00,0x00,0xff,
                 0xff,0xff,0xff,0x00,0x00,0x00,0xe3,0xe3,0xe3,0x00,0x00,0x00,0x00,0x00,0x00,0xff,
                 0xff,0xff,0xff,0xff,0x00,0x00,0x00,0xe3,0xff,0x00,0x00,0x00,0x00,0x00,0xff,0xff,},
				{                
                 0xff,0xff,0xff,0xff,0xff,0xff,0x24,0x24,0x24,0x24,0xff,0xff,0xff,0xff,0xff,0xff,
                 0xff,0xff,0xff,0xff,0xff,0x24,0x24,0x24,0x24,0x24,0x24,0xff,0xff,0xff,0xff,0xff,
                 0xff,0xff,0xff,0xff,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0xff,0xff,0xff,0xff,
                 0xff,0xff,0xff,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0xff,0xff,0xff,
                 0xff,0xff,0x24,0x00,0x00,0x24,0x24,0x24,0x24,0x24,0x24,0x00,0x00,0x24,0xff,0xff,
                 0xff,0x24,0x24,0x24,0xe3,0x00,0x24,0x24,0x24,0x24,0x00,0xe3,0x24,0x24,0x24,0xff,
                 0xff,0x24,0x24,0x24,0xe3,0x00,0x00,0x00,0x00,0x00,0x00,0xe3,0x24,0x24,0x24,0xff,
                 0x24,0x24,0x24,0x24,0xe3,0x00,0xe3,0x03,0xe0,0xe3,0x00,0xe3,0x24,0x24,0x24,0x24,
                 0x24,0x24,0x24,0x24,0xe3,0xe3,0xe3,0xe0,0x03,0xe3,0xe3,0xe3,0x24,0x24,0x24,0x24,
                 0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,
                 0xff,0x24,0x24,0x24,0x24,0xe3,0xe3,0xe3,0xe3,0xe3,0xe3,0x24,0x24,0x24,0x24,0xff,
                 0xff,0xff,0xff,0xff,0xe3,0xe3,0xe3,0xe3,0xe3,0xe3,0xe3,0xe3,0xff,0xff,0xff,0xff,
                 0xff,0xff,0x00,0x00,0xe3,0xe3,0xe3,0xe3,0xe3,0xe3,0xe3,0xe3,0xff,0xff,0xff,0xff,
                 0xff,0x00,0x00,0x00,0x00,0x00,0xe3,0xe3,0xe3,0xe3,0xe3,0x00,0x00,0xff,0xff,0xff,
                 0xff,0x00,0x00,0x00,0x00,0x00,0x00,0xe3,0xe3,0xe3,0x00,0x00,0x00,0xff,0xff,0xff,
                 0xff,0xff,0x00,0x00,0x00,0x00,0x00,0xff,0xe3,0x00,0x00,0x00,0xff,0xff,0xff,0xff,}	
};

unsigned char LevelBrick[3][20][15]={
			{	{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},//14
				{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},//29
				{0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},//44
				{0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},//59
				{0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},//74
				{0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},//89
				{0x03,0x00,0x00,0x02,0x00,0x03,0x00,0x00,0x00,0x00,0x03,0x00,0x00,0x00,0x00},//104
				{0x03,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x00,0x00,0x00,0x00},//119
				{0x03,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},//134
				{0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},//149
				{0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x00},//164
				{0x03,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},//179
				{0x03,0x01,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},//194
				{0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},//209
				{0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x00,0x03,0x00},//224
				{0x03,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x01,0x01,0x01,0x01,0x00},//239
				{0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},//254
				{0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},//269
				{0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03},//284
				{0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x04}//299
				},
			{	{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},//14
				{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},//29
				{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},//44
				{0x00,0x00,0x00,0x02,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x00},//59
				{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},//74
				{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x00,0x00,0x00,0x00,0x00},//89
				{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},//104
				{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x05,0x00,0x00,0x00},//119
				{0x00,0x00,0x00,0x05,0x00,0x05,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},//134
				{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},//149
				{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},//164
				{0x00,0x00,0x00,0x02,0x00,0x02,0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x00},//179
				{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00},//194
				{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00},//209
				{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00},//224
				{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x02,0x00,0x00,0x05,0x02,0x00},//239
				{0x00,0x00,0x00,0x02,0x02,0x01,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00},//254
				{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},//269
				{0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03},//284
				{0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x04}//299
				},
			{	{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},//14
				{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x00},//29
				{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},//44
				{0x00,0x00,0x00,0x02,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03},//59
				{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03},//74
				{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x03},//89
				{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03},//104
				{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03},//119
				{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x01,0x03},//134
				{0x00,0x00,0x00,0x00,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03},//149
				{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03},//164
				{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x00,0x03},//179
				{0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03},//194
				{0x01,0x01,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03},//209
				{0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03},//224
				{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03},//239
				{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x00,0x00,0x00,0x03},//254
				{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x00,0x00,0x00,0x03},//269
				{0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x03,0x00,0x00,0x00,0x03},//284
				{0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x04}//299
				}	
	};

	unsigned char Cubix[6][256]={
               { 0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
                 0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x00,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x00,
                 0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x00,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x00,
                 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//
                 0x24,0x24,0x24,0x00,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x00,0x24,0x24,0x24,0x24,
                 0x24,0x24,0x24,0x00,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x00,0x24,0x24,0x24,0x24,
                 0x24,0x24,0x24,0x00,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x00,0x24,0x24,0x24,0x24,
                 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//
                 0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x00,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x00,
                 0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x00,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x00,
                 0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x00,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x00,
                 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//
                 0x24,0x24,0x24,0x00,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x00,0x24,0x24,0x24,0x24,
                 0x24,0x24,0x24,0x00,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x00,0x24,0x24,0x24,0x24,
                 0x24,0x24,0x24,0x00,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x00,0x24,0x24,0x24,0x24,
                 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},//Mattone
				 
				 {
				 0xaa,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0xaa,
                 0x24,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,0x00,
                 0x24,0xfe,0x00,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,0x00,0xfe,0x00,
                 0x24,0xfe,0xfe,0xfe,0xfe,0x24,0x24,0x24,0x24,0x24,0xfe,0xfe,0xfe,0xfe,0xfe,0x00,//
                 0x24,0xfe,0xfe,0xfe,0x24,0x24,0x00,0x00,0x00,0x24,0x24,0xfe,0xfe,0xfe,0xfe,0x00,
                 0x24,0xfe,0xfe,0xfe,0x24,0x24,0x00,0xfe,0xfe,0x24,0x24,0x00,0xfe,0xfe,0xfe,0x00,
                 0x24,0xfe,0xfe,0xfe,0x24,0x24,0x00,0xfe,0xfe,0x24,0x24,0x00,0xfe,0xfe,0xfe,0x00,
                 0x24,0xfe,0xfe,0xfe,0xfe,0x00,0x00,0xfe,0x24,0x24,0x24,0x00,0xfe,0xfe,0xfe,0x00,//
                 0x24,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,0x24,0x24,0x00,0x00,0x00,0xfe,0xfe,0xfe,0x00,
                 0x24,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,0x24,0x24,0x00,0xfe,0xfe,0xfe,0xfe,0xfe,0x00,
                 0x24,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,0x00,0x00,0xfe,0xfe,0xfe,0xfe,0xfe,0x00,
                 0x24,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,0x24,0x24,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,0x00,//
                 0x24,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,0x24,0x24,0x00,0xfe,0xfe,0xfe,0xfe,0xfe,0x00,
                 0x24,0xfe,0x00,0xfe,0xfe,0xfe,0xfe,0xfe,0x00,0x00,0xfe,0xfe,0xfe,0x00,0xfe,0x00,
                 0x24,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,0x00,
                 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00//Bonus
				 },
				 {
				 0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,
                 0x00,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x00,
                 0x00,0x24,0x00,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x00,0x24,0x00,
                 0x00,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x00,
                 0x00,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x00,
                 0x00,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x00,
                 0x00,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x00,
                 0x00,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x00,
                 0x00,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x00,
                 0x00,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x00,
                 0x00,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x00,
                 0x00,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x00,
                 0x00,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x00,
                 0x00,0x24,0x00,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x00,0x24,0x00,
                 0x00,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x00,
                 0xaa,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa//Bonus empty
				 },
				 {
				 0x24,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x00,0x24,0xff,0xff,0xff,0xff,0x24,
                 0xff,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x00,0xff,0x24,0x24,0x24,0x24,0x00,
                 0xff,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x00,0xff,0x24,0x24,0x24,0x24,0x00,
                 0xff,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x00,0xff,0x24,0x24,0x24,0x24,0x00,
                 0xff,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x00,0xff,0x00,0x24,0x24,0x24,0x00,
                 0xff,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x00,0x24,0x00,0x00,0x00,0x00,0x24,
                 0xff,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x00,0xff,0xff,0xff,0xff,0xff,0x00,
                 0xff,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x00,0xff,0x24,0x24,0x24,0x24,0x00,
                 0xff,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x00,0xff,0x24,0x24,0x24,0x24,0x00,
                 0xff,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x00,0xff,0x24,0x24,0x24,0x24,0x00,
                 0x00,0x00,0x24,0x24,0x24,0x24,0x24,0x24,0x00,0xff,0x24,0x24,0x24,0x24,0x24,0x00,
                 0xff,0xff,0x00,0x00,0x24,0x24,0x24,0x24,0x00,0xff,0x24,0x24,0x24,0x24,0x24,0x00,//
                 0xff,0x24,0xff,0xff,0x00,0x00,0x00,0x00,0xff,0x24,0x24,0x24,0x24,0x24,0x24,0x00,
                 0xff,0x24,0x24,0x24,0xff,0xff,0xff,0x00,0xff,0x24,0x24,0x24,0x24,0x24,0x24,0x00,
                 0xff,0x24,0x24,0x24,0x24,0x24,0x24,0x00,0xff,0x24,0x24,0x24,0x24,0x24,0x00,0x00,
                 0x24,0x00,0x00,0x00,0x00,0x00,0x00,0x24,0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x24//ground
				 },
				 {
				 0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,//Bonus hide
                 0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,
                 0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,
                 0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,
                 0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,
                 0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,
                 0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,
                 0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,//Bonus hide
                 0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,
                 0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,
                 0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,
                 0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,
                 0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,
                 0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,
                 0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,
                 0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,
				 },
				 {
				 0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,//clear screen 16x16
                 0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,
                 0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,
                 0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,
                 0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,
                 0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,//clear screen 16x16
                 0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,
                 0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,
                 0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,
                 0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,
                 0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,//clear screen 16x16
                 0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,
                 0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,
                 0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,
                 0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,
                 0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,
				 }
				 };

char SmN=0;//SuperMarioNumber of draw
unsigned short int BrickPos[2]={16,0};
char EnForLevel[3]={2,3,4};
char Nlevl=0;
//char NElementActive=1;
_Bool level=1;
char UpdateSingleBlock[2]={16,0};
char En1=0, En2=0, En3=0, En4=0;
unsigned short int coin=0;
_Bool EdgeColl[4]={1,1,1,1};
signed short int add=0,minus=0;

////Bisogna inserire il n di array di mario, il n di array del nemico(3,4); la posizione di array va mandata gia aggiornata!
///il clear va messo su posizione precedente???

//Pulsanti;->abilita calcolo;

///calcolo;-> verifica collisione||next level;
//aggiorna pos array;
///DrawRefreshRate();

/*
if(PORTDbits.RD11==0){//se UP
	if(EdgeColl[0]==1) cuby-=inc;
}
if(PORTDbits.RD0==0){//if right
	if(EdgeColl[1]==1) cubx+=inc;
}
if(PORTDbits.RD10==0){//if left
	if(EdgeColl[2]==1) cubx-=inc;
}
if(PORTDbits.RD3==0){//down
	if(EdgeColl[3]==1) cuby+=inc;
}
*/
void loopSm(){
char i=0;
	//if((PORTDbits.RD11==0)&&(EdgeColl[0]==1))//se UP
	if(PORTDbits.RD11==0)
    {
		StartJump(0);//0->Sm
		SmN=1; //Jump draw
    }
	else EndJump(0);///quando rilascio up (salto breve)  se velocityY piu piccolo di -6 lo imposta a -6
	
	//if((PORTDbits.RD0==0)&&(EdgeColl[1]==1)){//if right
	if(PORTDbits.RD0==0){
		ItemPos[0][6]=1;//backfor=1-> mirror sm
		ItemPos[0][2]=4;//velocityX = 4;
		if(ItemPos[0][5]==1) SmN++;	// if onGround==1 plus sMn
		if((SmN==3)||(SmN==7))SmN=0;
	}
	
	//if((PORTDbits.RD10==0)&&(EdgeColl[2]==1)){//if left
	if(PORTDbits.RD10==0){
		ItemPos[0][6]=0;//backfor=0-> mirror sm
		ItemPos[0][2]=-4;//velocityX = -4;
		if(ItemPos[0][5]==1) SmN++; // if onGround==1 plus sMn
		if((SmN==3)||(SmN==7))SmN=0;
	}
	
	if((PORTDbits.RD0!=0)&&(PORTDbits.RD10!=0)&&(ItemPos[0][5]==1)){SmN=0; /*ItemPos[0][2]=0; //set to 0 velocityX*/} //set smN to static if onground and no action
	
	UpdatePosition();
	//CeckCollisionNewPhysics();
	CeckCollision();
		if(ItemPos[1][8]==1){
			En1++; 
			if(En1==3)  En1=1;
		}
		else En1=0;
		
		if(ItemPos[2][8]==1){
			En2++; 
			if(En2==3)  En2=1;
		}
		else En2=0;
		
		if(ItemPos[3][8]==1){
			En3++; 
			if(En3==3)  En3=1;
		}
		else En3=0;
		
		if(ItemPos[4][8]==1){
			En4++; 
			if(En4==3)  En4=1;
		}
		else En4=0;
	

	
	DrawRefreshRate(SmN, En1, En2, En3, En4);
	
	level=0;//disabilita inizializzazione nuovo livello
	BrickPos[0]=16;//disabilita stampa blocco in caso di collisione(bonus update)
	ItemPos[0][2]=0;//disabilita avanzamento Sm
	
}
void CeckCollision(void){
///se collisione sopra onground=1;OK
//se collisione sotto endjump;OK
//se collisione di fianco-> se sm ferma, se enemy inverti direzione//OK

//se onground=1 e nessuna collisione||collisione di fianco(bloccare movimento laterale) -> caduta libera
//se sm collisione di fianco, sotto a enemy-> sm die
//se collisione sm sopra enemy-> enemy die
//se sm > 310 ->sm die
 //se enemy > 310 ->enemy die
    unsigned char b=0,a=0,i=0;
	unsigned short int w=16,h=16;
	signed short int dx,dy,wy,hx;
	char TextBuffer[30];
	for(b=0; b<20; b++)
        {
            for(a=0; a<15; a++){
				
				if(LevelBrick[Nlevl][b][a]!=0x00){///solo sui blocchi attivi
				
					for(i=0;i<4; i++){
					
						if(ItemPos[i][8]!=0){//se non morto/disattivo
							dx=(signed short int)(((signed short int)a*16)+8)-(ItemPos[i][0]+8);
							dy=(signed short int)(((signed short int)b*16)+8)-(ItemPos[i][1]+8);
							if ((abs(dx) <= w) && (abs(dy) <= h)){
								wy=w*dy;
								hx=h*dx;
								if(wy > hx){
									if(wy > -hx){
										ItemPos[i][5]=1;//onground=1;
										ItemPos[i][1]=(b*16)-16;//positionY
										ItemPos[i][3]=0;//velocityY=0
										ItemPos[i][7]=1;//collision=1
									}
									else{
									if(((dx==-16)&&(dy==15))||((dx==16)&&(dy==15))||((dx==16)&&(dy==16))||((dx==-15)&&(dy==-15))||((dx==-15)&&(dy==15)));
									else{
										if(i==0) {											
												sprintf(TextBuffer,"SM X:%03d Y:%03d",ItemPos[0][0],ItemPos[0][1]);
												LCD_Text57(50,2,TextBuffer,1,RED,GREEN);
												sprintf(TextBuffer,"Distanza X:%03d Y:%03d",dx,dy);
												LCD_Text57(50,12,TextBuffer,1,RED,GREEN);
											
												sprintf(TextBuffer,"cubo X:%03d Y:%03d",a,b);
												LCD_Text57(50,22,TextBuffer,1,RED,GREEN);
												ItemPos[0][0] -= ItemPos[0][2];			
												//ItemPos[0][0] -=1;
												}///posx=posx-velx(ferma avanzamento)SM
											else {
												sprintf(TextBuffer,"EN X:%03d Y:%03d",dx,dy);
												LCD_Text57(50,32,TextBuffer,1,RED,GREEN);
												ItemPos[i][2]*=-1;
												}//se enemy inverte direzione
											ItemPos[i][7]=1;//collision=1
										}
									}
								}
								else{
									if(wy> -hx){
										if(((dx==-16)&&(dy==15))||((dx==16)&&(dy==15))||((dx==16)&&(dy==16))||((dx==-15)&&(dy==-15))||((dx==-15)&&(dy==15)));
									else{
										if(i==0) {											
												sprintf(TextBuffer,"SM X:%03d Y:%03d",ItemPos[0][0],ItemPos[0][1]);
												LCD_Text57(50,2,TextBuffer,1,RED,GREEN);
												sprintf(TextBuffer,"Distanza X:%03d Y:%03d",dx,dy);
												LCD_Text57(50,12,TextBuffer,1,RED,GREEN);
											
												sprintf(TextBuffer,"cubo X:%03d Y:%03d",a,b);
												LCD_Text57(50,22,TextBuffer,1,RED,GREEN);
												ItemPos[0][0] -= ItemPos[0][2];
												//ItemPos[0][0] -=1;
												}///posx=posx-velx(ferma avanzamento)SM
											else {
												//sprintf(TextBuffer,"EN X:%03d Y:%03d",dx,dy);
											//	LCD_Text57(50,32,TextBuffer,1,RED,GREEN);
												ItemPos[i][2]*=-1;
												}//se enemy inverte direzione
											ItemPos[i][7]=1;//collision=1
										}
										}
									else{
										ItemPos[i][1]=((b*16)+17);///positionY
										ItemPos[i][3]=6;//velocityY
										ItemPos[i][7]=1;//collision=1
										if(i==0){//controlla solo sm
											if((LevelBrick[Nlevl][b][a]==0x02)||(LevelBrick[Nlevl][b][a]==0x05)){
												LevelBrick[Nlevl][b][a]=0x03;
												coin+=10;
												BrickPos[0]=a;////se impostato aggiorna draw alla posizione della collisione
												BrickPos[1]=b;
											}
										}
									}							
								}							
							}	
						}
					}
				}			
			}			
		}
		//for(i=0;i<EnForLevel[Nlevl]+1; i++){
		for(i=0;i<4; i++){
		if(ItemPos[i][8]!=0){
			if((ItemPos[i][7]==0)&&(ItemPos[i][5]==1))///se collision=0 e onground=1
			{	
				if(i==0) SmN=0;
				ItemPos[i][5]=0;//onground=0
				ItemPos[i][3]=6;//velocityY=6-->caduta libera, da regolare la velocità
			}
			if(i!=0){
				///collisione sm sopra enemy
				if((((((ItemPos[i][0])+1)<=(ItemPos[0][0]+1))&&((ItemPos[0][0]+1)<=((ItemPos[i][0])+15)))||((((ItemPos[i][0])+1)<=(ItemPos[0][0]+15))&&((ItemPos[0][0]+15)<=((ItemPos[i][0])+14))))&&(((ItemPos[i][1])<=(ItemPos[0][1]+15))&&((ItemPos[0][1]+15)<=((ItemPos[i][1])+12)))){
					ItemPos[0][3] = -12.0;//velocityY (sm jump)
					ItemPos[0][5] = 0;//onGround
					ItemPos[i][8] = 0;//Die->local array
					LevelPosEn[Nlevl][i][2]=0;//die->init array		
					//EnForLevel[Nlevl]=EnForLevel[Nlevl]--;
				}
			}
			ItemPos[i][7]=0;
		}
		}
}

void CeckCollisionNewPhysics(void){
    unsigned char b=0,a=0,i=0;
	unsigned short int w=16,h=16;
	signed short int dx,dy,wy,hx;
	_Bool Ab=0;

	for(b=0; b<20; b++)
        {
            for(a=0; a<15; a++){
				if(LevelBrick[Nlevl][b][a]!=0x00){///solo sui blocchi attivi	
					for(i=0; i<4;i++){//numero di cubi da controllare
						dx=(signed short int)(a*16)-ItemPos[i][0];///blocco - enemy/sm X
						dy=(signed short int)(b*16)-ItemPos[i][1];//Y
						if ((abs(dx) <= w) && (abs(dy) <= h)){		///se collisione			
							wy=w*dy;
							hx=h*dx;
							if(wy > hx){
								if(wy > -hx){///collisione sopra oggetto
									ItemPos[i][5]=1;//onground=1;
									ItemPos[i][1]=(b*16)-16;//positionY
									ItemPos[i][3]=0;//velocityY=0
									ItemPos[i][7]=1;//collision=1
									
									if(i==0){//solo per sm disabilita comando
										EdgeColl[3]=0;///down button(non implementato)
										Ab=1;
									}
								}				
								else{///collisione a destra
									if((dx==-16)&&(dy==16));///non fa niente
									else{
										if(i==0){//se sm disabilita pulsante
											Ab=1;
											EdgeColl[2]=0;//left push disable
											//ItemPos[0][0] += ItemPos[0][2];	//se sm ritorna al valore precedente
											if((dx==-14)&&(dy==14)){ItemPos[0][0] += ItemPos[0][2];}///se sull'angolo torna indietro: ci arriva solo con un movimento obliquo(y+x).
										}
										else ItemPos[i][0] *=-1;//se nemico inverte direzione--Non controlla l'angolo interno									
										ItemPos[i][7]=1;//collision=1
									}
			
								}
							}	
							else{///collisione a sinistra
								if(wy> -hx){
									if((dx==16)&&(dy==16));///non fa niente
									else{
										if(i==0){//se sm disabilita pulsante
											Ab=1;
											EdgeColl[1]=0;//left push disable
											//ItemPos[0][0] += ItemPos[0][2];	//se sm ritorna al valore precedente
											if((dx==-14)&&(dy==14)){ItemPos[0][0] -= ItemPos[0][2];}///se sull'angolo torna indietro: ci arriva solo con un movimento obliquo(y+x).
										}
										else ItemPos[i][0] *=-1;//se nemico inverte direzione--Non controlla l'angolo interno									
										ItemPos[i][7]=1;//collision=1
									}
								}
								else{///collisione sotto
									if(((dx==-16)&&(dy==-16))||((dx==16)&&(dy==-16)));///non fa niente
									else{
										if(i==0){//se sm
											Ab=1;
											if(((dx==14)&&(dy==-14))||((dx==-14)&&(dy==-14))){
												if(dx==-14)ItemPos[0][0] += ItemPos[0][2];
												else ItemPos[0][0] -= ItemPos[0][2];
												EdgeColl[1]=0;
											}
											else{
												ItemPos[0][1]=((b*16)+16);///positionY
												ItemPos[0][3]=4;//velocityY
												ItemPos[0][7]=1;//collision=1
												if(i==0){//controlla solo sm
													if((LevelBrick[Nlevl][b][a]==0x02)||(LevelBrick[Nlevl][b][a]==0x05)){//controlla bonus
														LevelBrick[Nlevl][b][a]=0x03;
														coin+=10;
														BrickPos[0]=a;////se impostato aggiorna draw alla posizione della collisione
														BrickPos[1]=b;
													}
												}
											}
											///se sull'angolo torna indietro: ci arriva solo con un movimento obliquo(y+x).	
										}
										else {//se enemy
											//ItemPos[i][1]=((b*16)+16);///positionY
											//ItemPos[i][3]=4;//velocityY
											//ItemPos[i][7]=1;//collision=1
										}
									}			
								}						
							}	
						}
					}
				}
			}
		}
		if(Ab==0){ 
			EdgeColl[0]=1; 
			EdgeColl[1]=1; 
			EdgeColl[2]=1; 
			EdgeColl[3]=1;
			SmN=1;
			ItemPos[0][5]=0;//onground=0
			ItemPos[0][3]=4;//velocityY=6-->caduta libera, da regolare la velocità	
		}
		/*for(i=0;i<4; i++){
			if(ItemPos[i][8]!=0){
				ItemPos[i][5]=0;//onground=0
				ItemPos[i][3]=6;//velocityY=6-->caduta libera, da regolare la velocità
				ItemPos[i][7]=0; //Collision=0
			}	
		}*/
}
/*
void CeckCollision(void){
///se collisione sopra onground=1;OK
//se collisione sotto endjump;OK
//se collisione di fianco-> se sm ferma, se enemy inverti direzione//OK

//se onground=1 e nessuna collisione||collisione di fianco(bloccare movimento laterale) -> caduta libera
//se sm collisione di fianco, sotto a enemy-> sm die
//se collisione sm sopra enemy-> enemy die
//se sm > 310 ->sm die
 //se enemy > 310 ->enemy die
    unsigned char b=0,a=0,i=0;
	for(b=0; b<20; b++)
        {
            for(a=0; a<15; a++){
				
				if(LevelBrick[Nlevl][b][a]!=0x00){///solo sui blocchi attivi
				
					//for(i=0;i<EnForLevel[Nlevl]+1; i++){
					for(i=0;i<4; i++){
					
						if(ItemPos[i][8]!=0){//se non morto/disattivo
						///collisione sm sopra oggetti
						if((((((a*16)+1)<=(ItemPos[i][0]+1))&&((ItemPos[i][0]+1)<=((a*16)+15)))||((((a*16)+1)<=(ItemPos[i][0]+15))&&((ItemPos[i][0]+15)<=((a*16)+14))))&&(((b*16)<=(ItemPos[i][1]+15))&&((ItemPos[i][1]+15)<=((b*16)+12)))){
							ItemPos[i][5]=1;//onground=1;
							ItemPos[i][1]=(b*16)-16;//positionY
							ItemPos[i][3]=0;//velocityY=0
							ItemPos[i][7]=1;//collision=1
						}
				
						//collisione sotto all'oggetto
						if((((((a*16)+1)<=(ItemPos[i][0]+1))&&((ItemPos[i][0]+1)<=((a*16)+16)))||((((a*16)+1)<=(ItemPos[i][0]+15))&&((ItemPos[i][0]+15)<=((a*16)+14))))&&((((b*16)+6)<=(ItemPos[i][1]+1))&&((ItemPos[i][1]+1)<=((b*16)+18)))){
							ItemPos[i][1]=((b*16)+17);///positionY
							ItemPos[i][3]=6;//velocityY
							ItemPos[i][7]=1;//collision=1
							if(i==0){//controlla solo sm
								if((LevelBrick[Nlevl][b][a]==0x02)||(LevelBrick[Nlevl][b][a]==0x05)){
									LevelBrick[Nlevl][b][a]=0x03;
									coin+=10;
									BrickPos[0]=a;////se impostato aggiorna draw alla posizione della collisione
									BrickPos[1]=b;
								}
							}
						}
				
						//collisione a sx dell'oggetto
						if((((a*16)<=(ItemPos[i][0]+15))&&((ItemPos[i][0]+15)<=((a*16)+5)))&&(((((b*16)+1)<=(ItemPos[i][1]+1))&&((ItemPos[i][1]+1)<=((b*16)+14)))||((((b*16)+1)<=(ItemPos[i][1]+15))&&((ItemPos[i][1]+15)<=((b*16)+14))))){
							if(i==0) ItemPos[0][0] -= ItemPos[0][2];///posx=posx-velx(ferma avanzamento)SM
							else ItemPos[i][2]*=-1;//se enemy inverte direzione
							ItemPos[i][7]=1;//collision=1
						}
				
						//collisione a dx dell'oggetto
						if(((((a*16)+8)<=(ItemPos[i][0]+1))&&((ItemPos[i][0]+1)<=((a*16)+15)))&&(((((b*16)+1)<=(ItemPos[i][1]+1))&&((ItemPos[i][1]+1)<=((b*16)+14)))||((((b*16)+1)<=(ItemPos[i][1]+15))&&((ItemPos[i][1]+15)<=((b*16)+14))))){
							if(i==0) ItemPos[0][0] -= ItemPos[0][2];///posx=posx-velx(ferma avanzamento)SM
							else ItemPos[i][2]*=-1;//se enemy inverte direzione
							ItemPos[i][7]=1;//collision=1
						}
					}
					}
				}			
			}
				
		}
		//for(i=0;i<EnForLevel[Nlevl]+1; i++){
		for(i=0;i<4; i++){
		if(ItemPos[i][8]!=0){
			if((ItemPos[i][7]==0)&&(ItemPos[i][5]==1))///se collision=0 e onground=1
			{	
				if(i==0) SmN=0;
				ItemPos[i][5]=0;//onground=0
				ItemPos[i][3]=6;//velocityY=6-->caduta libera, da regolare la velocità
			}
			if(i!=0){
				///collisione sm sopra enemy
				if((((((ItemPos[i][0])+1)<=(ItemPos[0][0]+1))&&((ItemPos[0][0]+1)<=((ItemPos[i][0])+15)))||((((ItemPos[i][0])+1)<=(ItemPos[0][0]+15))&&((ItemPos[0][0]+15)<=((ItemPos[i][0])+14))))&&(((ItemPos[i][1])<=(ItemPos[0][1]+15))&&((ItemPos[0][1]+15)<=((ItemPos[i][1])+12)))){
					ItemPos[0][3] = -12.0;//velocityY (sm jump)
					ItemPos[0][5] = 0;//onGround
					ItemPos[i][8] = 0;//Die->local array
					LevelPosEn[Nlevl][i][2]=0;//die->init array		
					//EnForLevel[Nlevl]=EnForLevel[Nlevl]--;
				}
			}
			ItemPos[i][7]=0;
		}
		}
		
		

}*/
void UpdatePosition(void){
char i=0;

	if(ItemPos[0][0]>225){
		Nlevl++;
		if(Nlevl==3)Nlevl--;//Da completare
		else LoadLevel(1);//paramtro passato serve per recuperare la posizione di SM (a sinistra)
	}
	if(ItemPos[0][0]<5){
		Nlevl--;
		if(Nlevl==255)Nlevl++;//Da completare
		else LoadLevel(0);//paramtro passato serve per recuperare la posizione di SM(a destra)
	}
	//salva posizione attuale
	//for(i=0;i<EnForLevel[Nlevl]+1; i++){////+1-> enemy+sm
	for(i=0;i<5; i++){
		OldItemPos[i][0]=ItemPos[i][0];//positionX 
		OldItemPos[i][1]=ItemPos[i][1];//positionY 
	}
	//Aggiorna posizione di tutti gli elementi attivi
	//for(i=0;i<EnForLevel[Nlevl]+1; i++){////+1-> enemy+sm
	for(i=0;i<5; i++){
		if(ItemPos[i][8]!=0){
			ItemPos[i][0]+=ItemPos[i][2];//positionX += velocityX;
			ItemPos[i][3]+=ItemPos[i][4];//velocityY += gravity;
			ItemPos[i][1]+=ItemPos[i][3];//positionY += velocityY;
		}
	}
	
	
	///da inserire controllo die qui(baratro)???
}

void LoadLevel(char posSm){
	char i=0;
///Inizializzare posizione nemici in base al numero di livello

	//salva posizione nemici livello precedete
	if(posSm){
		for(i=0; i<4; i++){	
			LevelPosEn[Nlevl-1][i][0]=ItemPos[i+1][0];
			LevelPosEn[Nlevl-1][i][1]=ItemPos[i+1][1];
			LevelPosEn[Nlevl-1][i][2]=ItemPos[i+1][8];	
		}
	}
	else {
		for(i=0; i<4; i++){	
			LevelPosEn[Nlevl+1][i][0]=ItemPos[i+1][0];
			LevelPosEn[Nlevl+1][i][1]=ItemPos[i+1][1];
			LevelPosEn[Nlevl+1][i][2]=ItemPos[i+1][8];	
		}
	}

	//for(i=0; i<EnForLevel[Nlevl]+1; i++){///EnForLevel[Nlevl]-> ogni livello ha il suo numero di nemici
	for(i=0; i<4; i++){	
		ItemPos[i+1][0]=LevelPosEn[Nlevl][i][0];
		ItemPos[i+1][1]=LevelPosEn[Nlevl][i][1];
		ItemPos[i+1][8]=LevelPosEn[Nlevl][i][2];///update local array die/live
		
	}
	if(posSm) {
		ItemPos[0][0]=16;
		OldItemPos[0][0]=16;
	}
	else {
		ItemPos[0][0]=224;
		OldItemPos[0][0]=224;
		}
	level=1;//abilita stampa del nuovo livello
}

void EndJump(char a)
{
    if(ItemPos[a][3] < -6.0)//velocityY
        ItemPos[a][3] = -6.0;
}
void StartJump(char a)
{
    if(ItemPos[a][5])//onGround==1
    {
        ItemPos[a][3] = -12.0;//velocityY
        ItemPos[a][5] = 0;//onGround
    }
}

//En impostati a 0 non disegna niente
//nSm sempre aggiornato!0,1,2,0,1,2....
//se impostato level, stampa nuovo livello in base a Nlevl

//bisogna aggiornare BrickPos[0],BrickPos[1]: rilevata collisione stampa il bonus empty(x,y assoluti)
//BrickPos[0]=16 non aggiorna bonus in caso di collisione

///no background!!

void DrawRefreshRate(char nSM, char En1,char En2,char En3,char En4){

	if(level) DrawLevel();

	switch(nSM){
		case 0:
			DrawSM((unsigned char)OldItemPos[0][0], OldItemPos[0][1],0,ItemPos[0][6],1);//Clear Sm
			DrawSM((unsigned char)ItemPos[0][0], ItemPos[0][1],2,ItemPos[0][6],0);//drawSm 2
		break;
		case 1:
			DrawSM((unsigned char)OldItemPos[0][0], OldItemPos[0][1],0,ItemPos[0][6],1);//Clear Sm
			DrawSM((unsigned char)ItemPos[0][0], ItemPos[0][1],1,ItemPos[0][6],0);//drawSm 1
		break;
		case 2:
			DrawSM((unsigned char)OldItemPos[0][0], OldItemPos[0][1],0,ItemPos[0][6],1);//Clear Sm
			DrawSM((unsigned char)ItemPos[0][0], ItemPos[0][1],0,ItemPos[0][6],0);//drawSm 0
		break;
		case 5:
			DrawSM((unsigned char)OldItemPos[0][0], OldItemPos[0][1],0,ItemPos[0][6],1);//Clear Sm
			DrawSM((unsigned char)ItemPos[0][0], ItemPos[0][1],2,ItemPos[0][6],0);//drawSm 2
		break;
	}	
	switch(En1){///if(En1!=1)||(En1!=2) non esguire
		case 1:
			DrawSM((unsigned char)OldItemPos[1][0], OldItemPos[1][1],0,ItemPos[1][6],1);//Clear En
			DrawSM((unsigned char)ItemPos[1][0], ItemPos[1][1],3,ItemPos[1][6],0);//drawEn 0
		break;
		case 2:
			DrawSM((unsigned char)OldItemPos[1][0], OldItemPos[1][1],0,ItemPos[1][6],1);//Clear En
			DrawSM((unsigned char)ItemPos[1][0], ItemPos[1][1],4,ItemPos[1][6],0);//drawEn 1
		break;
	}
	switch(En2){///if(En1!=1)||(En1!=2) non esguire
		case 1:
			DrawSM((unsigned char)OldItemPos[2][0], OldItemPos[2][1],0,ItemPos[2][6],1);//Clear En
			DrawSM((unsigned char)ItemPos[2][0], ItemPos[2][1],3,ItemPos[2][6],0);//drawEn 0
		break;
		case 2:
			DrawSM((unsigned char)OldItemPos[2][0], OldItemPos[2][1],0,ItemPos[2][6],1);//Clear En
			DrawSM((unsigned char)ItemPos[2][0], ItemPos[2][1],4,ItemPos[2][6],0);//drawEn 1
		break;
	}
	switch(En3){///if(En1!=1)||(En1!=2) non esguire
		case 1:
			DrawSM((unsigned char)OldItemPos[3][0], OldItemPos[3][1],0,ItemPos[3][6],1);//Clear En
			DrawSM((unsigned char)ItemPos[3][0], ItemPos[3][1],3,ItemPos[3][6],0);//drawEn 0
		break;
		case 2:
			DrawSM((unsigned char)OldItemPos[3][0], OldItemPos[3][1],0,ItemPos[3][6],1);//Clear En
			DrawSM((unsigned char)ItemPos[3][0], ItemPos[3][1],4,ItemPos[3][6],0);//drawEn 1
		break;
	}
	switch(En4){///if(En1!=1)||(En1!=2) non esguire
		case 1:
			DrawSM((unsigned char)OldItemPos[4][0], OldItemPos[4][1],0,ItemPos[4][6],1);//Clear En
			DrawSM((unsigned char)ItemPos[4][0], ItemPos[4][1],3,ItemPos[4][6],0);//drawEn 0
		break;
		case 2:
			DrawSM((unsigned char)OldItemPos[4][0], OldItemPos[4][1],0,ItemPos[4][6],1);//Clear En
			DrawSM((unsigned char)ItemPos[4][0], ItemPos[4][1],4,ItemPos[4][6],0);//drawEn 1
		break;
	}
	if(BrickPos[0]!=16){
		//if(LevelBrick[Nlevl][BrickPos[0]][BrickPos[1]]==0x02){//se bonus
			DrawBrick(BrickPos[0],BrickPos[1],2);
			//LevelBrick[Nlevl][BrickPos[0]][BrickPos[1]]=0x03;
		//}
		//if(LevelBrick[Nlevl][BrickPos[0]][BrickPos[1]]==0x05){//se bonus hide
			//DrawBrick(BrickPos[0],BrickPos[1],2);
			//LevelBrick[Nlevl][BrickPos[0]][BrickPos[1]]=0x03;
		//}
	
	}
	DelayMs(10);
}

void DrawBrick(unsigned char x, unsigned short int y, unsigned char Brickn){
unsigned char a=0,b=0,i=0;
for(b=0; b<16; b++)
		{
			for(a=0; a<16; a++)
			{		
				if(Cubix[Brickn][i]==0xfe) LCD_Pixel(x*16+a,y*16+b,RGB16(0xea,0x9e,0x22));//gold
				if(Cubix[Brickn][i]==0xff) LCD_Pixel(x*16+a,y*16+b,RGB16(0xff,0xc0,0xcb));//Pink
				if(Cubix[Brickn][i]==0x24) LCD_Pixel(x*16+a,y*16+b,RGB16(0xa5,0x2a,0x2a));//Brown
				if(Cubix[Brickn][i]==0x00) LCD_Pixel(x*16+a,y*16+b,BLACK);
				if(Cubix[Brickn][i]==0x0b) LCD_Pixel(x*16+a,y*16+b,RGB16(0x92,0x90,0xff));//sfondo
				i++;
			}	
		}
}

void DrawLevel()
{
    unsigned char a=0,b=0;
    unsigned short int i=0;

	///clear all 
        for(b=0; b<19; b++)
            {
                for(a=0; a<15; a++)
                    {
                        DrawBrick(a,b,5);
                    }
            }
	//print all
        for(b=0; b<20; b++)
            {
                for(a=0; a<15; a++)
                    {
                        if(LevelBrick[Nlevl][b][a]==0x01) DrawBrick(a,b,0);
                        if(LevelBrick[Nlevl][b][a]==0x02) DrawBrick(a,b,1);
                        if(LevelBrick[Nlevl][b][a]==0x03) DrawBrick(a,b,2);
                        if(LevelBrick[Nlevl][b][a]==0x04) DrawBrick(a,b,3);
                        if(LevelBrick[Nlevl][b][a]==0x05) DrawBrick(a,b,4);
                    }
            }

}

void DrawSM(unsigned char x, unsigned short int y, unsigned char SMn, _Bool ForBack, _Bool ClearSM)
{
	unsigned char i=0;
	signed char a=0,b=0;
	if (ForBack)
	{
		for(b=0; b<16; b++)
		{
			for(a=0; a<16; a++)
			{		
				//if(mario[SMn][i]==0xff) LCD_Pixel(x+a,y+b,WHITE);
				if(mario[SMn][i]==0x03) LCD_Pixel(x+a,y+b,BLUE);
				if(mario[SMn][i]==0xe3) LCD_Pixel(x+a,y+b,RGB16(0xff,0xc0,0xcb));//Pink
				if(mario[SMn][i]==0xe0) LCD_Pixel(x+a,y+b,RED);
				if(mario[SMn][i]==0x24) LCD_Pixel(x+a,y+b,RGB16(0xa5,0x2a,0x2a));//Brown
				if(mario[SMn][i]==0x00) LCD_Pixel(x+a,y+b,BLACK);
				i++;
			}	
		}
	}
	else
	{
	i=15;
		for(b=0; b<16; b++)
		{
			for(a=0; a<16; a++)
			{		
				//if(mario[SMn][i]==0xff) LCD_Pixel(x+a,y+b,WHITE);
				if(mario[SMn][i]==0x03) LCD_Pixel(x+a,y+b,BLUE);
				if(mario[SMn][i]==0xe3) LCD_Pixel(x+a,y+b,RGB16(0xff,0xc0,0xcb));//Pink
				if(mario[SMn][i]==0xe0) LCD_Pixel(x+a,y+b,RED);
				if(mario[SMn][i]==0x24) LCD_Pixel(x+a,y+b,RGB16(0xa5,0x2a,0x2a));//Brown
				if(mario[SMn][i]==0x00) LCD_Pixel(x+a,y+b,BLACK);
				i--;
			}
			i=i+32;
		}
	}
	if(ClearSM)
	{
		for(b=0; b<16; b++)
		{
			for(a=0; a<16; a++)
			{		
				LCD_Pixel(x+a,y+b,RGB16(0x92,0x90,0xff));
			}	
		}
	}
}

void CollisionTest(void){
char inc=4;
_Bool DisableMov[4]={0,0,0,1};
unsigned short int cuby=144,cubx=120;
unsigned short int w=16,h=16;
signed short int dx,dy,wy,hx,VelocityY=0,Gravity=2;
signed short int xfix[12]={56,72,88,104,120,136,152,152,40,56,120,88};
signed short int yfix[12]={160,160,160,160,160,160,160,144,192,176,112,112};
_Bool OverLap=0;
char TextBuffer[30];
LCD_CLS(WHITE);
add=0;
while(TRUE){

LCD_Rect(cubx,cuby,cubx+15,cuby+15,1,WHITE);

//if(PORTDbits.RD11==0){//se UP
//	if(DisableMov[0]==0) cuby-=inc;
//}

if(DisableMov[3]==0){//se non in collisione sopra(in salto o caduta libera)
	VelocityY += Gravity;
	if(VelocityY>=14) VelocityY=14;
	cuby+=VelocityY;
	}

if(add==1){//se up 
	if(DisableMov[3]==1){//se sulla collisione sopra
		VelocityY=-16;
		DisableMov[3]=0;///rimuove collisione sopra
		VelocityY += Gravity;
		cuby+=VelocityY;
		
	}
	add=0;//disattiva rientrata
}

if(minus==1) {
	if(VelocityY < -8.0) VelocityY = -8.0;//velocityY	
	minus=0;
}



if(PORTDbits.RD0==0){//if right
	if(DisableMov[1]==0) cubx+=inc;
}
if(PORTDbits.RD10==0){//if left
	if(DisableMov[2]==0) cubx-=inc;
}
if(PORTDbits.RD3==0){//down
	if(DisableMov[3]==0) cuby+=inc;
}

for(i=0; i<4;i++) DisableMov[i]=0;

for(i=0; i<12;i++){//numero di cubi da controllare

if(VelocityY<=0){
if(((cubx>=xfix[i])&&(cubx<=xfix[i]+15))&&((cuby>=yfix[i])&&(cuby<=(yfix[i]+15)))){///collisione sotto
	OverLap=1;
	sprintf(TextBuffer,"DOWN X:%03d Y:%03d",dx,dy);
	LCD_Text57(50,42,TextBuffer,1,BLACK,WHITE);
	cuby=yfix[i]+16;
	VelocityY=2;
	}
if((((cubx+15)>=xfix[i])&&((cubx+15)<=(xfix[i]+15)))&&((cuby>=yfix[i])&&(cuby<=(yfix[i]+15)))){//collisione sotto oggetto
	OverLap=1;
	sprintf(TextBuffer,"DOWN X:%03d Y:%03d",dx,dy);
	LCD_Text57(50,42,TextBuffer,1,BLACK,WHITE);
	cuby=yfix[i]+16;
	VelocityY=2;
}
}
if(VelocityY>0){
if(((cubx>=xfix[i])&&(cubx<=(xfix[i]+15)))&&(((cuby+15)>=yfix[i])&&((cuby+15)<=(yfix[i]+15)))){//collisione sopra oggetto
	OverLap=1;
	sprintf(TextBuffer,"UP X:%03d Y:%03d",dx,dy);
	LCD_Text57(50,12,TextBuffer,1,BLACK,WHITE);
	DisableMov[3]=1;//disattiva discesa
	cuby=yfix[i]-16;
}

if((((cubx+15)>=xfix[i])&&((cubx+15)<=(xfix[i]+15)))&&(((cuby+15)>=yfix[i])&&((cuby+15)<=(yfix[i]+15)))){//collisione sopra oggetto
	OverLap=1;
	sprintf(TextBuffer,"UP X:%03d Y:%03d",dx,dy);
	LCD_Text57(50,12,TextBuffer,1,BLACK,WHITE);
	DisableMov[3]=1;//disattiva discesa
	cuby=yfix[i]-16;
}
}


if(!OverLap){
dx=(signed short int)(xfix[i])-cubx;
dy=(signed short int)(yfix[i])-cuby;
if ((abs(dx) <= w) && (abs(dy) <= h)){

	wy=w*dy;
	hx=h*dx;
	if(wy > hx){
		if(wy > -hx){///collisione sopra oggetto
					sprintf(TextBuffer,"UP X:%03d Y:%03d",dx,dy);
					LCD_Text57(50,12,TextBuffer,1,BLACK,WHITE);
					DisableMov[3]=1;//disattiva discesa
					cuby=yfix[i]-16;
					}
		else{///collisione a destra
			
			if((dx==-16)&&(dy==16)) {/*EdgeColl[0]=1; EdgeColl[1]=1; EdgeColl[2]=1; EdgeColl[3]=1;*/}///non fa niente
			else{
				
				sprintf(TextBuffer,"RIGHT X:%03d Y:%03d",dx,dy);
				LCD_Text57(50,22,TextBuffer,1,BLACK,WHITE);
				if((dx==-14)&&((dy>=-6)&&(dy<=12))){cubx+=inc; DisableMov[2]=1;}///se sull'angolo torna indietro: ci arriva solo con un movimento obliquo(y+x).
				else {DisableMov[2]=1;}
				
				//if(dx<=-8){
				//	DisableMov[0]=1;
				//	cuby=yfix[i]+16;
				//	VelocityY=2;						
				//}
				}
			
			}
	}
	else{///collisione a sinistra
		if(wy> -hx){
					if((dx==16)&&(dy==16)) {/*EdgeColl[0]=1; EdgeColl[1]=1; EdgeColl[2]=1; if(DownOk==0)EdgeColl[3]=1;*/}///non fa niente
					else{
						sprintf(TextBuffer,"LEFT X:%03d Y:%03d",dx,dy);
						LCD_Text57(50,32,TextBuffer,1,BLACK,WHITE);
						
						if((dx<=14)&&((dy>=-6)&&(dy<=12))){cubx-=inc; DisableMov[1]=1;}///se sull'angolo torna indietro: ci arriva solo con un movimento obliquo(y+x).
						else {	DisableMov[1]=1;}
						//if(dx<=13){
						//	DisableMov[0]=1;
						//	cuby=yfix[i]+16;
						//	VelocityY=2;						
						//}
						}
					}
		else{///collisione sotto
			if(((dx==-16)&&(dy==-16))||((dx==16)&&(dy==-16))) {/*EdgeColl[0]=1; EdgeColl[1]=1; EdgeColl[2]=1; EdgeColl[3]=1;*/}///non fa niente
			else{
				sprintf(TextBuffer,"DOWN X:%03d Y:%03d",dx,dy);
				LCD_Text57(50,42,TextBuffer,1,BLACK,WHITE);
				if(((dx==14)&&(dy==-14))||((dx==-14)&&(dy==-14))){
					if(dx==-14){cubx+=inc; DisableMov[2]=1;}
					else {cubx-=inc; DisableMov[1]=1;}
					}///se sull'angolo torna indietro: ci arriva solo con un movimento obliquo(y+x).
				else DisableMov[0]=1;	///disattiva salita
				cuby=yfix[i]+16;
				VelocityY=2;
				}
			
			}						
		}	
	
}
}
OverLap=0;
}



LCD_Rect(cubx,cuby,cubx+15,cuby+15,0,BLUE);
LCD_Rect(xfix[0],yfix[0],xfix[0]+15,yfix[0]+15,0,RED);
LCD_Rect(xfix[1],yfix[1],xfix[1]+15,yfix[1]+15,0,GREEN);

LCD_Rect(xfix[2],yfix[2],xfix[2]+15,yfix[2]+15,0,RED);
LCD_Rect(xfix[3],yfix[3],xfix[3]+15,yfix[3]+15,0,GREEN);

LCD_Rect(xfix[4],yfix[4],xfix[4]+15,yfix[4]+15,0,RED);
LCD_Rect(xfix[5],yfix[5],xfix[5]+15,yfix[5]+15,0,GREEN);
LCD_Rect(xfix[6],yfix[6],xfix[6]+15,yfix[6]+15,0,RED);
LCD_Rect(xfix[7],yfix[7],xfix[7]+15,yfix[7]+15,0,GREEN);

LCD_Rect(xfix[8],yfix[8],xfix[8]+15,yfix[8]+15,0,RED);
LCD_Rect(xfix[9],yfix[9],xfix[9]+15,yfix[9]+15,0,GREEN);

LCD_Rect(xfix[10],yfix[10],xfix[10]+15,yfix[10]+15,0,GREEN);

LCD_Rect(xfix[11],yfix[11],xfix[11]+15,yfix[11]+15,0,RED);
DelayMs(25);
}
}

void CollisionTestTwo(void){
char inc=4,a=0;
_Bool DisableMov[4]={0,0,0,1};

_Bool DisableMovUp[5]={0,0,0,1};
_Bool DisableMovDown[5]={0,0,0,1};
_Bool DisableMovLeft[5]={0,0,0,1};
_Bool DisableMovRight[5]={0,0,0,1};

unsigned short int cuby[3]={144,144,144};
unsigned short int cubx[3]={120,120,72};

unsigned short int w=16,h=16;
signed short int dx,dy,wy,hx,Gravity=2;
signed short int VelocityY[3]={0,0,0};
signed short int VelocityX[3]={0,1,2};

//signed short int xfix[14]={56,72,88,104,120,136,152,152,40,56,120,88,24,8};
//signed short int yfix[14]={160,160,160,160,160,160,160,144,192,176,112,112,192,176};

signed short int xfix[14]={8,24,40,56,72,88,104,120,136,152,168,184,200,120};
signed short int yfix[14]={144,160,160,160,160,160,160,160,160,160,160,160,144,112};

_Bool OverLap=0;
char TextBuffer[30];
LCD_CLS(WHITE);
DelayMs(100);
add=1;
LCD_Rect(xfix[0],yfix[0],xfix[0]+15,yfix[0]+15,0,RED);
LCD_Rect(xfix[1],yfix[1],xfix[1]+15,yfix[1]+15,0,GREEN);

LCD_Rect(xfix[2],yfix[2],xfix[2]+15,yfix[2]+15,0,RED);
LCD_Rect(xfix[3],yfix[3],xfix[3]+15,yfix[3]+15,0,GREEN);

LCD_Rect(xfix[4],yfix[4],xfix[4]+15,yfix[4]+15,0,RED);
LCD_Rect(xfix[5],yfix[5],xfix[5]+15,yfix[5]+15,0,GREEN);
LCD_Rect(xfix[6],yfix[6],xfix[6]+15,yfix[6]+15,0,RED);
LCD_Rect(xfix[7],yfix[7],xfix[7]+15,yfix[7]+15,0,GREEN);

LCD_Rect(xfix[8],yfix[8],xfix[8]+15,yfix[8]+15,0,RED);
LCD_Rect(xfix[9],yfix[9],xfix[9]+15,yfix[9]+15,0,GREEN);

LCD_Rect(xfix[10],yfix[10],xfix[10]+15,yfix[10]+15,0,GREEN);

LCD_Rect(xfix[11],yfix[11],xfix[11]+15,yfix[11]+15,0,RED);

LCD_Rect(xfix[12],yfix[12],xfix[12]+15,yfix[12]+15,0,RED);
LCD_Rect(xfix[13],yfix[13],xfix[13]+15,yfix[13]+15,0,GREEN);

    LCD_FastRect(60,285,80,305,BLUE);//left
    LCD_FastRect(85,285,105,305,GREEN);//Down
    LCD_FastRect(110,285,130,305,RED);//right
    LCD_FastRect(85,260,105,280,PURPLE);//up

while(TRUE){
if(PORTDbits.RD3==0) break;
LCD_Rect(cubx[0],cuby[0],cubx[0]+15,cuby[0]+15,1,WHITE);
LCD_Rect(cubx[1],cuby[1],cubx[1]+15,cuby[1]+15,1,WHITE);
LCD_Rect(cubx[2],cuby[2],cubx[2]+15,cuby[2]+15,1,WHITE);

//if(PORTDbits.RD11==0){//se UP
//	if(DisableMov[0]==0) cuby-=inc;
//}

if(DisableMov[3]==0){//se non in collisione sopra(in salto o caduta libera)
	VelocityY[0] += Gravity;
	if(VelocityY[0]>=14) VelocityY[0]=14;
	cuby[0]+=VelocityY[0];
	}

if(DisableMovDown[1]==0){//se non in collisione sopra(in salto o caduta libera)
	VelocityY[1] += Gravity;
	if(VelocityY[1]>=14) VelocityY[1]=14;
	cuby[1]+=VelocityY[1];
	}	
	
if(DisableMovDown[2]==0){//se non in collisione sopra(in salto o caduta libera)
	VelocityY[2] += Gravity;
	if(VelocityY[2]>=14) VelocityY[2]=14;
	cuby[2]+=VelocityY[2];
	}	
	

if(add==1){//se up 
	if(DisableMov[3]==1){//se sulla collisione sopra
		VelocityY[0]=-16;
		DisableMov[3]=0;///rimuove collisione sopra
		VelocityY[0] += Gravity;
		cuby[0]+=VelocityY[0];
		
	}
	add=0;//disattiva rientrata
}

if(minus==1) {
	if(VelocityY[0] < -8.0) VelocityY[0] = -8.0;//velocityY	
	minus=0;
}


if(ReadTouch()==Up){//if right
    add=1;
}

//if(PORTDbits.RD0==0){//if right
if(ReadTouch()==Right){//if right
	if(DisableMov[1]==0) cubx[0]+=inc;
}
if(ReadTouch()==Left){//if left
	if(DisableMov[2]==0) cubx[0]-=inc;
}
if(PORTDbits.RD3==0){//down
	if(DisableMov[3]==0) cuby[0]+=inc;
}

cubx[1]+=VelocityX[1];///incrementa posizione in x automatica(nessun controllo attiva/disattiva)
cubx[2]+=VelocityX[2];

for(i=0; i<4;i++) {
	DisableMov[i]=0;
	DisableMovUp[i]=0;
	DisableMovDown[i]=0;
	DisableMovLeft[i]=0;
	DisableMovRight[i]=0;
	}
	
for(a=0; a<3;a++){//numero di elementi in movimento

for(i=0; i<14;i++){//numero di cubi da controllare

if(VelocityY[a]<=0){
if(((cubx[a]>=xfix[i])&&(cubx[a]<=xfix[i]+15))&&((cuby[a]>=yfix[i])&&(cuby[a]<=(yfix[i]+15)))){///collisione sotto
	OverLap=1;
	//sprintf(TextBuffer,"DOWN X:%03d Y:%03d",dx,dy);
	//LCD_Text57(50,42,TextBuffer,1,BLACK,WHITE);
	cuby[a]=yfix[i]+16;
	VelocityY[a]=2;
	}
if((((cubx[a]+15)>=xfix[i])&&((cubx[a]+15)<=(xfix[i]+15)))&&((cuby[a]>=yfix[i])&&(cuby[a]<=(yfix[i]+15)))){//collisione sotto oggetto
	OverLap=1;
	//sprintf(TextBuffer,"DOWN X:%03d Y:%03d",dx,dy);
	//LCD_Text57(50,42,TextBuffer,1,BLACK,WHITE);
	cuby[a]=yfix[i]+16;
	VelocityY[a]=2;
}
}
if(VelocityY[a]>0){
if(((cubx[a]>=xfix[i])&&(cubx[a]<=(xfix[i]+15)))&&(((cuby[a]+15)>=yfix[i])&&((cuby[a]+15)<=(yfix[i]+15)))){//collisione sopra oggetto
	OverLap=1;
	//sprintf(TextBuffer,"UP X:%03d Y:%03d",dx,dy);
	//LCD_Text57(50,12,TextBuffer,1,BLACK,WHITE);
	DisableMov[3]=1;//disattiva discesa
	DisableMovDown[a]=1;
	
	cuby[a]=yfix[i]-16;
}

if((((cubx[a]+15)>=xfix[i])&&((cubx[a]+15)<=(xfix[i]+15)))&&(((cuby[a]+15)>=yfix[i])&&((cuby[a]+15)<=(yfix[i]+15)))){//collisione sopra oggetto
	OverLap=1;
	//sprintf(TextBuffer,"UP X:%03d Y:%03d",dx,dy);
	//LCD_Text57(50,12,TextBuffer,1,BLACK,WHITE);
	DisableMov[3]=1;//disattiva discesa
	DisableMovDown[a]=1;
	
	cuby[a]=yfix[i]-16;
}
}


if(!OverLap){
dx=(signed short int)(xfix[i])-cubx[a];
dy=(signed short int)(yfix[i])-cuby[a];
if ((abs(dx) <= w) && (abs(dy) <= h)){

	wy=w*dy;
	hx=h*dx;
	if(wy > hx){
		if(wy > -hx){///collisione sopra oggetto
					//sprintf(TextBuffer,"UP X:%03d Y:%03d",dx,dy);
					//LCD_Text57(50,12,TextBuffer,1,BLACK,WHITE);
					if(a>0)DisableMovDown[a]=1;
					else DisableMov[3]=1;//disattiva discesa				
					cuby[a]=yfix[i]-16;
					}
		else{///collisione a destra
			
			if((dx==-16)&&(dy==16)) {/*EdgeColl[0]=1; EdgeColl[1]=1; EdgeColl[2]=1; EdgeColl[3]=1;*/}///non fa niente
			else{
				
				//sprintf(TextBuffer,"RIGHT X:%03d Y:%03d",dx,dy);
				//LCD_Text57(50,22,TextBuffer,1,BLACK,WHITE);
				if((dx==-14)&&((dy>=-6)&&(dy<=12))){
					if(a>0) VelocityX[a]*=-1;
					else{
						cubx[a]+=inc; 
						DisableMov[2]=1;
					}
				}///se sull'angolo torna indietro: ci arriva solo con un movimento obliquo(y+x).
				else {
					if(a>0) VelocityX[a]*=-1;
					else DisableMov[2]=1; 				
				}
				
				//if(dx<=-8){
				//	DisableMov[0]=1;
				//	cuby=yfix[i]+16;
				//	VelocityY=2;						
				//}
				}
			
			}
	}
	else{///collisione a sinistra
		if(wy> -hx){
					if((dx==16)&&(dy==16)) {/*EdgeColl[0]=1; EdgeColl[1]=1; EdgeColl[2]=1; if(DownOk==0)EdgeColl[3]=1;*/}///non fa niente
					else{
						//sprintf(TextBuffer,"LEFT X:%03d Y:%03d",dx,dy);
						//LCD_Text57(50,32,TextBuffer,1,BLACK,WHITE);
						
						if((dx<=14)&&((dy>=-6)&&(dy<=12))){
							if(a>0) VelocityX[a]*=-1;
							else{
								cubx[a]-=inc; 
								DisableMov[1]=1;
							}						
						}///se sull'angolo torna indietro: ci arriva solo con un movimento obliquo(y+x).
						else {
							if(a>0) VelocityX[a]*=-1;
							else DisableMov[1]=1; 						
							}
						//if(dx<=13){
						//	DisableMov[0]=1;
						//	cuby=yfix[i]+16;
						//	VelocityY=2;						
						//}
						}
					}
		else{///collisione sotto
			if(((dx==-16)&&(dy==-16))||((dx==16)&&(dy==-16))) {/*EdgeColl[0]=1; EdgeColl[1]=1; EdgeColl[2]=1; EdgeColl[3]=1;*/}///non fa niente
			else{
				//sprintf(TextBuffer,"DOWN X:%03d Y:%03d",dx,dy);
				//LCD_Text57(50,42,TextBuffer,1,BLACK,WHITE);
				if(((dx==14)&&(dy==-14))||((dx==-14)&&(dy==-14))){
					if(dx==-14){
						if(a>0) VelocityX[a]=-1;
						else{
							cubx[0]+=inc; 
							DisableMov[2]=1; 
						}
						
					}
					else {
						if(a>0) VelocityX[a]*=-1;
						else{
							cubx[0]-=inc; 
							DisableMov[1]=1; 
						}
						
						}
					}///se sull'angolo torna indietro: ci arriva solo con un movimento obliquo(y+x).
				else {
					if(a>0) VelocityX[a]*=-1;
					else DisableMov[0]=1;	///disattiva salita
					
					}
					
				cuby[a]=yfix[i]+16;
				VelocityY[a]=2;
				}
			
			}						
		}	
	
}
}
OverLap=0;
}
}


LCD_Rect(cubx[0],cuby[0],cubx[0]+15,cuby[0]+15,0,BLUE);
LCD_Rect(cubx[1],cuby[1],cubx[1]+15,cuby[1]+15,0,RED);
LCD_Rect(cubx[2],cuby[2],cubx[2]+15,cuby[2]+15,0,GREEN);


DelayMs(25);
}
}
